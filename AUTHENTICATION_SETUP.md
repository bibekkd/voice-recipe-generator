# Authentication Setup Guide

This document explains how authentication is implemented in your Voice Recipe Finder & AI Cooking Assistant App using Supabase and Zustand for state management.

## Overview

The app now includes a complete authentication system that:
- Connects to your Supabase backend
- Uses Zustand for lightweight, efficient state management
- Handles user sign-up and sign-in
- Automatically creates user records in your `users` table
- Protects routes based on authentication status
- Provides user context throughout the app

## Files Created/Modified

### New Files
- `lib/supabase.ts` - Supabase client configuration
- `stores/authStore.ts` - Zustand authentication store
- `components/ProtectedRoute.tsx` - Route protection component
- `components/AuthInitializer.tsx` - Authentication initialization
- `hooks/useAuth.ts` - Custom hook for auth store
- `hooks/useAuthState.ts` - Custom hook for auth state

### Modified Files
- `app/_layout.tsx` - Added AuthInitializer wrapper
- `app/auth/index.tsx` - Integrated with Zustand auth store
- `app/(tabs)/_layout.tsx` - Added route protection
- `app/(tabs)/profile.tsx` - Added user info and sign-out

## Database Schema

### Users Table Structure
The `users` table has been updated to properly link with Supabase Auth:

```sql
-- Original structure with added auth_user_id column
CREATE TABLE users (
  id BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  auth_user_id UUID UNIQUE,  -- Links to Supabase auth.users.id
  username TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  profile_picture TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Key Changes Made
1. **Added `auth_user_id` column**: Links your custom users table to Supabase Auth
2. **Unique constraint**: Ensures one-to-one relationship between auth and custom users
3. **Index**: Improves query performance for auth lookups

## Architecture

### Zustand Store Structure
```typescript
interface AuthState {
  user: User | null;
  session: Session | null;
  loading: boolean;
  isAuthenticated: boolean;
  isGuest: boolean;
}

interface AuthActions {
  setUser: (user: User | null) => void;
  setSession: (session: Session | null) => void;
  setLoading: (loading: boolean) => void;
  signUp: (email: string, password: string, username: string) => Promise<{ error: any }>;
  signIn: (email: string, password: string) => Promise<{ error: any }>;
  signOut: () => Promise<void>;
  initializeAuth: () => Promise<(() => void) | undefined>;
}
```

## How It Works

### 1. Authentication Flow
1. User visits auth screen
2. User enters email/password (and username for sign-up)
3. App calls Zustand store actions
4. Store calls Supabase auth API
5. On successful sign-up, user record is created in your `users` table with `auth_user_id`
6. User is automatically redirected to main app
7. Authentication state is maintained across app restarts

### 2. State Management
- **Zustand Store**: Centralized authentication state
- **Automatic Updates**: State updates trigger component re-renders
- **Persistent State**: Authentication state persists across app restarts
- **Efficient Updates**: Only components using auth state re-render

### 3. Route Protection
- **Protected Routes**: Main app tabs require authentication
- **Public Routes**: Auth screen and onboarding are public
- **Automatic Redirects**: Users are redirected based on auth status

### 4. User Data
- User information is stored in Supabase Auth
- Additional user data is stored in your custom `users` table
- Tables are linked via `auth_user_id` column
- Profile screen displays actual user information

## Database Integration

When a user signs up:
1. Supabase creates an auth user
2. App creates a record in your `users` table with:
   - `auth_user_id`: Links to Supabase auth user ID
   - `username`: From sign-up form
   - `email`: From sign-up form
   - `created_at` and `updated_at`: Timestamps
   - `id`: Auto-generated by database

## Usage Examples

### Using Authentication in Components

```tsx
import { useAuth } from '../hooks/useAuth';

export default function MyComponent() {
  const { user, signOut, isAuthenticated } = useAuth();
  
  if (!isAuthenticated) {
    return <Text>Please sign in</Text>;
  }
  
  return (
    <View>
      <Text>Welcome, {user?.email}!</Text>
      <Button onPress={signOut} title="Sign Out" />
    </View>
  );
}
```

### Using the Auth State Hook

```tsx
import { useAuthState } from '../hooks/useAuthState';

export default function MyComponent() {
  const { userProfile, isAuthenticated, isGuest } = useAuthState();
  
  return (
    <View>
      {isAuthenticated && (
        <Text>Hello, {userProfile.username}!</Text>
      )}
      {isGuest && (
        <Text>Please sign in to continue</Text>
      )}
    </View>
  );
}
```

### Direct Store Access (Advanced)

```tsx
import { useAuthStore } from '../stores/authStore';

export default function MyComponent() {
  const user = useAuthStore((state) => state.user);
  const signOut = useAuthStore((state) => state.signOut);
  
  return (
    <View>
      <Text>User ID: {user?.id}</Text>
      <Button onPress={signOut} title="Sign Out" />
    </View>
  );
}
```

## Configuration

The Supabase configuration is in `lib/supabase.ts`:
- **URL**: Your Supabase project URL
- **Anon Key**: Your project's anonymous API key

## Benefits of Zustand

- **Lightweight**: Smaller bundle size than Redux
- **Simple API**: Easy to use and understand
- **TypeScript Support**: Full type safety
- **Performance**: Efficient re-renders
- **DevTools**: Built-in debugging support
- **No Providers**: No need to wrap components in providers

## Security Features

- **Row Level Security (RLS)**: Currently disabled in your tables
- **Password Hashing**: Handled by Supabase Auth
- **Session Management**: Automatic session persistence
- **Route Protection**: Unauthenticated users can't access protected routes
- **Database Linking**: Secure connection between auth and custom user data

## Testing

1. **Sign Up**: Create a new account with email/password/username
2. **Sign In**: Use existing credentials
3. **Profile**: View user information and sign out
4. **Route Protection**: Try accessing tabs without authentication
5. **Database Verification**: Check that users appear in your `users` table

## Troubleshooting

### Common Issues

1. **Authentication Failed**: Check Supabase project status and API keys
2. **User Not Created**: Verify database permissions and table structure
3. **Redirect Loops**: Check ProtectedRoute logic and auth state
4. **State Not Updating**: Ensure components are using the correct hooks
5. **Signup Errors**: Verify `auth_user_id` column exists and is properly configured

### Recent Fixes

**Fixed Signup Error**: The original error "Column 'id' is an identity column defined as GENERATED ALWAYS" was resolved by:
1. Adding `auth_user_id` column to link with Supabase Auth
2. Removing manual `id` field insertion
3. Letting the database auto-generate the `id` field

### Debug Steps

1. Check browser console for errors
2. Verify Supabase project is active
3. Check database table structure matches expected schema
4. Verify API keys are correct
5. Use Zustand devtools to inspect store state
6. Check that `auth_user_id` column exists in users table

## Next Steps

Consider implementing:
- **Email Verification**: Enable in Supabase dashboard
- **Password Reset**: Add forgot password functionality
- **Social Login**: Google, Apple, etc.
- **Profile Management**: Edit user information
- **Avatar Upload**: Profile picture functionality
- **Offline Support**: Handle authentication state offline
- **User Data Sync**: Sync custom user data with auth state

## Support

If you encounter issues:
1. Check Supabase dashboard for project status
2. Verify database tables and permissions
3. Check app logs for error messages
4. Ensure all dependencies are installed correctly
5. Use Zustand devtools for debugging
6. Verify database schema matches the expected structure
